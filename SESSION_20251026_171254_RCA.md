# Root Cause Analyse – Session 20251026_171254

**Session:** `session_20251026_171254`  
**Run ID:** `1136a0c4`  
**Start:** 2025‑10‑26 17:12:54 UTC  
**Status:** Bot blieb im Live-Modus ohne aktive Positionen

---

## 1. Ablaufüberblick

1. Setup & Initialisierung erfolgreich (Märkte geladen, Budget 154.86 USDT).
2. Trading Engine startete, Drop-Scanner evaluierte alle 137 Symbole.
3. Mehrere Kaufintents wurden erzeugt (`4/USDT`, `COAI/USDT`, `GIGGLE/USDT`, `MBG/USDT` u. a.).
4. MBG und 4/USDT wurden teilweise gefüllt (Budget committed), andere Intents landeten im `stale_intent_cleanup`.
5. Lauf dauerte ~6 Minuten und wurde durch massive Market-Data-Warnungen begleitet.

---

## 2. Auffälligkeiten & Warnungen

### 2.1 Markt-Daten Pipeline
- `Market conditions update failed: 'MarketDataProvider' object has no attribute 'get_ohlcv_history'` (mehrfach ab 17:20:07).
- `MD_POLL cycle overrun: 11.63s > 1.50s` sowie weitere Overruns (7s, 5s, 4s …) → Ticker-Verarbeitung dauerte deutlich länger als der Sollwert von 1.5 s.
- Symbol `XPLUS/USDT` erzeugte 18 `BadSymbol`-Retries („mexc does not have market symbol XPLUS/USDT“) und wurde mehrfach degradiert (`MD_SYMBOL_DEGRADED`).

### 2.2 Orderfluss / Budget
- `events_20251026_171254.jsonl` zeigt Reserve/Commit für MBG und 4/USDT – Orders wurden also teilweise gefüllt.
- Andere Symbole (COAI/GIGGLE) endeten im `stale_intent_cleanup` → OrderRouter versuchte zu lange, bis die Intent-TTL ablief.
- Keine `ORDER_FAILED` Meldungen in `system_...` für diese Session – im Gegensatz zur vorherigen Session.

### 2.3 Logging / Infrastruktur
- Kein `trace_steps.log` Lärm (fix umgesetzt).  
- Keine Rolling-Window-Persistenzfehler mehr (Fix aktiv).

---

## 3. Root Causes

1. **Market conditions update nutzt veraltete API** – der Aufrufer erwartet `MarketDataProvider.get_ohlcv_history`, die Klasse hat diese Methode nicht mehr. Jeder Invoke löst Exception + Poll-Overrun aus und blockiert den Market-Data-Thread. Dadurch laufen Signale verspätet ein oder werden gar nicht mehr geprüft.
2. **Symbol-Liste enthält nicht mehr handelbares Paar (`XPLUS/USDT`)** – Exchange kennt das Symbol nicht → jede Abfrage retried 0.25/0.5/1s, danach Degradation. Die wiederholten Retries verlängern ebenfalls die MD-Polls und verschlechtern Ausführungszeiten.
3. **Stale Intents trotz erfolgreicher Fills** – für COAI/GIGGLE wurden Budget-Reservierungen angelegt, aber nie committed. Ursachen:
   - Market-Data-Lags → OrderRouter verschickt Order, aber Exchange antwortet zu langsam / Intent läuft ab.
   - oder Guard/Drop-Checks wurden erneut getriggert, obwohl der erste Intent noch pending war → TTL 60s → `stale_intent_cleanup`.

---

## 4. Lösungsvorschläge

1. **Market Conditions Fix**  
   - Datei: `services/market_conditions.py` (oder der Aufrufer, der `get_ohlcv_history` erwartet).  
   - Statt `market_data.get_ohlcv_history()` die neue API nutzen (`self.market_data.ohlcv_history` oder `get_ohlcv(symbol, ...)`).  
   - Alternativ die Funktion im MarketDataProvider wieder anbieten (thin wrapper, der auf `self.ohlcv_history` zugreift).

2. **Symbol-Liste validieren / filtern**  
   - Beim Laden der Märkte `exchange.has['fetchTicker']` und `symbol in exchange.symbols` prüfen, bevor ein Symbol in `topcoins` aufgenommen wird.  
   - `XPLUS/USDT` aus `topcoins_keys` entfernen oder per Exchange-Autodetect filtern.  
   - Error-Handling im MarketDataProvider: wenn `BadSymbol`, Symbol direkt auf eine Skip-List setzen statt dutzende Retries.

3. **Stale-Intent-Batching verkürzen**  
   - `INTENT_STALE_THRESHOLD_S` aktuell 60 s – bei langsamer Market-Data-Pipeline läuft das Timeout, obwohl das Buch schon geupdated ist.  
   - Option: beim OrderRouter auf Fills warten, Intent sofort clearen (selbst bei Teilfills).  
   - Guard: `pending_buy_intents` vor neuem Intent prüfen – existiert bereits ein Intent für Symbol? Dann keinen weiteren erzeugen.

4. **Monitoring / Telemetrie**  
   - Poll-Overruns >5 s sollten `event_type='MD_POLL_OVERRUN'` bekommen und (optional) Slack/TG warnen.  
   - MD-Error-Count in Dashboard anzeigen, damit man sofort sieht, dass der MD-Thread hängt.

---

## 5. Nächste Schritte

1. `get_ohlcv_history`-Zugriff korrigieren und XPLUS/USDT aus der Liste entfernen.  
2. Anschließend Session erneut starten und prüfen, ob Poll-Overruns verschwinden und Intents innerhalb der TTL gefüllt werden.  
3. Optional: INTENT_STALE_THRESHOLD auf 30 s senken, sobald MarketData stabil ist.
